# Cross-platform set of build steps for building esy projects

steps:
  - script: npm install -g esy@0.5.6
    displayName: 'npm install -g esy@0.5.6'
  - script: esy install
    displayName: 'esy install'
  - script: esy build
    displayName: 'esy build'
  # Run tests or any additional steps here
  # - script: esy b dune runtest
  # - script: "npm install"
  #   workingDirectory: "examples/example-project"
  #   displayName: "[Prepare tests] example-project"
  # - script: "npm install"
  #   workingDirectory: "examples/example-es6-imports"
  #   displayName: "[Prepare tests] example-es6-imports"
  # - script: "npm install"
  #   workingDirectory: "examples/example-react"
  #   displayName: "[Prepare tests] example-react"
  # - script: "npm install"
  #   workingDirectory: "examples/name_with_underscore"
  #   displayName: "[Prepare tests] name_with_underscore"
  - script: "yarn install"
    workingDirectory: "examples/bs-7.0.1"
    displayName: "[Prepare tests] bs-7.0.1 - install"
  - script: "yarn build"
    workingDirectory: "examples/bs-7.0.1"
    displayName: "[Prepare tests] bs-7.0.1 - build"
  - script: esy x ExamplesTests
  - script: esy x UtilTests.exe
  - bash: mkdir -p rls-release
  - bash: cp _esy/default/build/default/bin/Bin.exe rls-release/reason-language-server.exe
  - task: PublishBuildArtifacts@1
    displayName: 'Upload binary'
    inputs:
        pathToPublish: 'rls-release'
        artifactName: 'rls-$(Agent.OS)'
        parallel: true
        parallelCount: 8
